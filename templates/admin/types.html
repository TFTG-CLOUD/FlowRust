{% extends "admin/base.html" %}

{% block title %}分类管理 - 管理后台{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Header Section -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-blue-100 rounded-lg">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                    </path>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">分类管理</h1>
                <p class="text-gray-600">管理视频分类和分类层级结构</p>
            </div>
        </div>
        <button onclick="openAddModal()"
            class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            添加分类
        </button>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">总分类数</p>
                    <p class="text-3xl font-bold text-gray-900" id="totalTypes">{{ types|length }}</p>
                </div>
                <div class="p-3 bg-blue-100 rounded-full">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                        </path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">启用分类</p>
                    <p class="text-3xl font-bold text-green-600" id="activeTypes">
                        {% set active_count = 0 %}
                        {% for type in types %}
                        {% if type.type_status == 1 %}
                        {% set_global active_count = active_count + 1 %}
                        {% endif %}
                        {% endfor %}
                        {{ active_count }}
                    </p>
                </div>
                <div class="p-3 bg-green-100 rounded-full">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">顶级分类</p>
                    <p class="text-3xl font-bold text-purple-600" id="parentTypes">
                        {% set parent_count = 0 %}
                        {% for type in types %}
                        {% if type.type_pid == 0 %}
                        {% set_global parent_count = parent_count + 1 %}
                        {% endif %}
                        {% endfor %}
                        {{ parent_count }}
                    </p>
                </div>
                <div class="p-3 bg-purple-100 rounded-full">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                        </path>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">子分类</p>
                    <p class="text-3xl font-bold text-orange-600" id="subTypes">
                        {% set sub_count = 0 %}
                        {% for type in types %}
                        {% if type.type_pid != 0 %}
                        {% set_global sub_count = sub_count + 1 %}
                        {% endif %}
                        {% endfor %}
                        {{ sub_count }}
                    </p>
                </div>
                <div class="p-3 bg-orange-100 rounded-full">
                    <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z">
                        </path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="bg-white rounded-lg shadow-sm border">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">分类列表</h2>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="搜索分类..."
                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <svg class="absolute left-3 top-2.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <select id="statusFilter"
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">全部状态</option>
                        <option value="1">启用</option>
                        <option value="0">禁用</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">分类名称
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">上级分类
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">英文名称
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">排序
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="typesTable">
                    {% if types %}
                    {% for type in types %}
                    <tr class="hover:bg-gray-50 transition-colors" id="type-row-{{ type.type_id }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ type.type_id }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8">
                                    <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                        <span class="text-sm font-medium text-blue-600">{{
                                            type.type_name|truncate(length=1, end="")|upper
                                            }}</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ type.type_name }}</div>
                                    {% if type.type_des %}
                                    <div class="text-sm text-gray-500">{{ type.type_des|truncate(length=30) }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if type.type_pid == 0 %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">顶级分类</span>
                            {% else %}
                            {% for parent in types %}
                            {% if parent.type_id == type.type_pid %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">{{
                                parent.type_name }}</span>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ type.type_en |
                            default(value="--") }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ type.type_sort |
                            default(value=0) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if type.type_status == 1 %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                启用
                            </span>
                            {% else %}
                            <span
                                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                禁用
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center gap-2">
                                <button onclick="editType('{{ type.type_id }}')"
                                    class="inline-flex items-center p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                    title="编辑">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                        </path>
                                    </svg>
                                </button>
                                <button onclick="confirmDeleteType('{{ type._id }}')"
                                    class="inline-flex items-center p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                    title="删除">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                                    </path>
                                </svg>
                                <p class="text-lg font-medium">暂无分类数据</p>
                                <p class="text-sm text-gray-400 mt-1">点击"添加分类"按钮创建第一个分类</p>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 添加/编辑分类模态框 -->
<div id="typeModal" class="fixed inset-0 z-[80] hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity z-40" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="relative z-50 inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="typeModalTitle">添加分类</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="typeForm" class="space-y-6">
                    <input type="hidden" id="typeId" name="type_id">

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="typeName" class="block text-sm font-medium text-gray-700 mb-2">分类名称 *</label>
                            <input type="text" id="typeName" name="type_name" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="typeEn" class="block text-sm font-medium text-gray-700 mb-2">英文名称</label>
                            <input type="text" id="typeEn" name="type_en"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="typePid" class="block text-sm font-medium text-gray-700 mb-2">上级分类</label>
                            <select id="typePid" name="type_pid"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="0">顶级分类</option>
                                {% for type in types %}
                                <option value="{{ type.type_id }}">{{ type.type_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="typeSort" class="block text-sm font-medium text-gray-700 mb-2">排序</label>
                            <input type="number" id="typeSort" name="type_sort" value="0"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="typeStatus" class="block text-sm font-medium text-gray-700 mb-2">状态</label>
                            <select id="typeStatus" name="type_status"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">启用</option>
                                <option value="0">禁用</option>
                            </select>
                        </div>
                        <div>
                            <label for="typeMid" class="block text-sm font-medium text-gray-700 mb-2">模型ID</label>
                            <input type="number" id="typeMid" name="type_mid" value="1"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="typeKey" class="block text-sm font-medium text-gray-700 mb-2">SEO关键词</label>
                            <input type="text" id="typeKey" name="type_key"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="typeTitle" class="block text-sm font-medium text-gray-700 mb-2">SEO标题</label>
                            <input type="text" id="typeTitle" name="type_title"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>

                    <div>
                        <label for="typeDes" class="block text-sm font-medium text-gray-700 mb-2">SEO描述</label>
                        <textarea id="typeDes" name="type_des" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="subarea" class="block text-sm font-medium text-gray-700 mb-2">地区筛选</label>
                            <input type="text" id="subarea" name="subarea" placeholder="如: 大陆,香港,台湾,美国,日本,韩国"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-xs text-gray-500">可用半角逗号分隔多个地区，用于一级分类页面的筛选条件</p>
                        </div>
                        <div>
                            <label for="subyear" class="block text-sm font-medium text-gray-700 mb-2">年份筛选</label>
                            <input type="text" id="subyear" name="subyear" placeholder="如: 2025,2024,2023,2022,2021"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-xs text-gray-500">可用半角逗号分隔多个年份，用于一级分类页面的筛选条件</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="submit" form="typeForm"
                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    保存
                </button>
                <button type="button" onclick="closeModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    取消
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div id="deleteModal" class="fixed inset-0 z-[80] hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity z-40" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div
            class="relative z-50 inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div
                        class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
                            </path>
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">确认删除</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">确定要删除这个分类吗？此操作不可恢复。</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="handleDelete()"
                    class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    删除
                </button>
                <button type="button" onclick="closeDeleteModal()"
                    class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    取消
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast 通知 -->
<div id="toast"
    class="fixed top-4 right-4 z-[70] transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="bg-white rounded-lg shadow-lg border-l-4 p-4 max-w-sm">
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <svg id="toastIcon" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="ml-3">
                <p id="toastMessage" class="text-sm font-medium text-gray-900"></p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    var typesData = {{ types | json_encode() | safe }};
    let currentTypeId = null;
    let currentDeleteId = null;

    document.addEventListener('DOMContentLoaded', function () {
        // 表单提交事件
        document.getElementById('typeForm').addEventListener('submit', handleSubmit);

        // 搜索和过滤功能
        setupFilters();

        console.log('分类管理页面已加载，分类数据:', typesData);
    });

    // 设置搜索和过滤功能
    function setupFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');

        searchInput.addEventListener('input', filterTable);
        statusFilter.addEventListener('change', filterTable);
    }

    // 过滤表格
    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const rows = document.querySelectorAll('#typesTable tr');

        rows.forEach(row => {
            const cells = row.getElementsByTagName('td');
            if (cells.length === 0) return; // Skip header row

            const name = cells[1].textContent.toLowerCase();
            const status = row.querySelector('[id^="type-row-"]') ?
                (row.querySelector('.bg-green-100') ? '1' : '0') : '';

            const matchesSearch = name.includes(searchTerm) || searchTerm === '';
            const matchesStatus = statusFilter === '' || status === statusFilter;

            row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        });
    }

    // 打开添加模态框
    function openAddModal() {
        currentTypeId = null;
        document.getElementById('typeModalTitle').textContent = '添加分类';
        document.getElementById('typeForm').reset();
        document.getElementById('typeId').value = '';
        document.getElementById('typeSort').value = '0';
        document.getElementById('typeMid').value = '1';
        document.getElementById('typeStatus').value = '1';
        updateParentOptions();
        document.getElementById('typeModal').classList.remove('hidden');
    }

    // 编辑分类
    function editType(id) {
        console.log('editType called with id:', id, 'type:', typeof id);
        console.log('typesData:', typesData);

        const type = typesData.find(t => {
            console.log('Comparing:', t.type_id, 'with', id, 'types:', typeof t.type_id, typeof id);
            return t.type_id == id; // 使用 == 而不是 === 来处理类型转换
        });

        console.log('Found type:', type);

        if (!type) {
            console.error('Type not found for id:', id);
            return;
        }

        currentTypeId = id;
        document.getElementById('typeModalTitle').textContent = '编辑分类';

        // 填充表单
        document.getElementById('typeId').value = type.type_id;
        document.getElementById('typeName').value = type.type_name;
        document.getElementById('typeEn').value = type.type_en || '';
        document.getElementById('typePid').value = type.type_pid;
        document.getElementById('typeSort').value = type.type_sort || 0;
        document.getElementById('typeStatus').value = type.type_status;
        document.getElementById('typeMid').value = type.type_mid || 1;
        document.getElementById('typeKey').value = type.type_key || '';
        document.getElementById('typeTitle').value = type.type_title || '';
        document.getElementById('typeDes').value = type.type_des || '';
        document.getElementById('subarea').value = type.subarea || '';
        document.getElementById('subyear').value = type.subyear || '';

        updateParentOptions();

        console.log('About to show modal');
        const modal = document.getElementById('typeModal');
        console.log('Modal element:', modal);
        modal.classList.remove('hidden');
        console.log('Modal classes after remove hidden:', modal.className);
    }

    // 更新父级分类选项
    function updateParentOptions() {
        const select = document.getElementById('typePid');
        const currentValue = select.value;
        select.innerHTML = '<option value="0">顶级分类</option>';

        typesData.forEach(type => {
            if (currentTypeId !== type.type_id) {
                const option = document.createElement('option');
                option.value = type.type_id;
                option.textContent = type.type_name;
                select.appendChild(option);
            }
        });

        select.value = currentValue;
    }

    // 关闭模态框
    function closeModal() {
        document.getElementById('typeModal').classList.add('hidden');
    }

    // 处理表单提交
    async function handleSubmit(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = {
            type_name: formData.get('type_name'),
            type_en: formData.get('type_en') || undefined,
            type_pid: parseInt(formData.get('type_pid')) || 0,
            type_sort: parseInt(formData.get('type_sort')) || 0,
            type_status: parseInt(formData.get('type_status')) || 0,
            type_mid: parseInt(formData.get('type_mid')) || 1,
            type_key: formData.get('type_key') || undefined,
            type_title: formData.get('type_title') || undefined,
            type_des: formData.get('type_des') || undefined,
            subarea: formData.get('subarea') || undefined,
            subyear: formData.get('subyear') || undefined
        };

        try {
            let response;
            if (currentTypeId) {
                // 更新
                response = await fetch(`/api/admin/types/${currentTypeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                // 创建
                response = await fetch('/api/admin/types', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                const result = await response.json();
                closeModal();
                showToast(result.message || '操作成功！', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const errorData = await response.json();
                showToast('操作失败: ' + (errorData.message || '未知错误'), 'error');
            }
        } catch (error) {
            console.error('提交出错:', error);
            showToast('操作失败: ' + error.message, 'error');
        }
    }

    // 确认删除分类
    function confirmDeleteType(id) {
        currentDeleteId = id;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    // 关闭删除确认模态框
    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        currentDeleteId = null;
    }

    // 处理删除操作
    async function handleDelete() {
        if (!currentDeleteId) return;

        try {
            const response = await fetch(`/api/admin/types/${currentDeleteId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                closeDeleteModal();
                showToast(result.message || '删除成功！', 'success');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                const errorData = await response.json();
                showToast('删除失败: ' + (errorData.message || '未知错误'), 'error');
            }
        } catch (error) {
            console.error('删除出错:', error);
            showToast('删除失败: ' + error.message, 'error');
        }
    }

    // 显示Toast通知
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toastIcon');
        const toastMessage = document.getElementById('toastMessage');
        const toastContainer = toast.querySelector('div');

        // 设置消息和图标
        toastMessage.textContent = message;

        if (type === 'success') {
            toastContainer.className = 'bg-white rounded-lg shadow-lg border-l-4 border-green-400 p-4 max-w-sm';
            toastIcon.className = 'h-5 w-5 text-green-400';
            toastIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>';
        } else {
            toastContainer.className = 'bg-white rounded-lg shadow-lg border-l-4 border-red-400 p-4 max-w-sm';
            toastIcon.className = 'h-5 w-5 text-red-400';
            toastIcon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>';
        }

        // 显示toast
        toast.classList.remove('translate-x-full');

        // 3秒后自动隐藏
        setTimeout(() => {
            toast.classList.add('translate-x-full');
        }, 3000);
    }
</script>
{% endblock %}