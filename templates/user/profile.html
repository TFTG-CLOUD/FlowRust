{% extends "base.html" %}

{% block title %}用户中心 - {{ SITENAME | default(value='影视天堂') }}{% endblock %}

{% block meta_description %}用户中心 - 查看个人信息和观看记录{% endblock %}

{% block meta_keywords %}用户中心,个人中心,观看记录{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 py-8">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- 用户中心头部 -->
    <div
      class="bg-gradient-to-r from-pink-500/10 via-blue-500/10 to-purple-500/10 rounded-2xl p-8 mb-8 border border-pink-500/20 backdrop-blur-sm">
      <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">
        <!-- 用户头像 -->
        <div class="flex-shrink-0">
          <img id="userAvatarLarge" src="/static/images/default-avatar.svg" alt="用户头像"
            class="w-24 h-24 rounded-full border-4 border-pink-500 object-cover shadow-lg">
        </div>

        <!-- 用户信息 -->
        <div class="flex-1 text-center sm:text-left">
          <h1 id="userDisplayNameLarge" class="text-3xl font-bold text-white mb-3">用户</h1>
          <div class="flex flex-col sm:flex-row gap-3 text-gray-300 text-sm">
            <span class="flex items-center gap-2">
              <i class="fas fa-user text-pink-400"></i>
              <span>用户名: <span id="username" class="text-white font-medium">-</span></span>
            </span>
            <span class="flex items-center gap-2">
              <i class="fas fa-envelope text-blue-400"></i>
              <span>邮箱: <span id="email" class="text-white font-medium">-</span></span>
            </span>
            <span class="flex items-center gap-2">
              <i class="fas fa-calendar text-green-400"></i>
              <span>注册时间: <span id="regDate" class="text-white font-medium">-</span></span>
            </span>
          </div>
        </div>

        <!-- 操作按钮 -->
        <div class="flex-shrink-0 flex gap-3">
          <button onclick="showUseCardModal()"
            class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105 shadow-lg">
            <i class="fas fa-credit-card mr-2"></i>使用卡卷
          </button>
          <button onclick="goToBuyCard()"
            class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105 shadow-lg">
            <i class="fas fa-shopping-cart mr-2"></i>购买卡卷
          </button>
          <button onclick="editProfile()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-all duration-200 transform hover:scale-105 shadow-lg">
            <i class="fas fa-edit mr-2"></i>编辑资料
          </button>
        </div>
      </div>
    </div>

    <!-- 统计信息 -->
    <div class="bg-gray-800 rounded-2xl p-6 mb-8 shadow-xl">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
          <i class="fas fa-chart-bar text-pink-500"></i>
          统计信息
        </h2>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="bg-gray-700 rounded-xl p-6 text-center transform hover:scale-105 transition-transform duration-200">
          <div class="text-3xl font-bold text-pink-500 mb-2" id="totalWatched">0</div>
          <div class="text-gray-400 text-sm font-medium">观看影片</div>
        </div>

        <div class="bg-gray-700 rounded-xl p-6 text-center transform hover:scale-105 transition-transform duration-200">
          <div class="text-3xl font-bold text-blue-500 mb-2" id="totalTime">0h</div>
          <div class="text-gray-400 text-sm font-medium">观看时长</div>
        </div>

        <div class="bg-gray-700 rounded-xl p-6 text-center transform hover:scale-105 transition-transform duration-200">
          <div class="text-3xl font-bold text-green-500 mb-2" id="userPoints">0</div>
          <div class="text-gray-400 text-sm font-medium">积分</div>
        </div>

        <div class="bg-gray-700 rounded-xl p-6 text-center transform hover:scale-105 transition-transform duration-200">
          <div class="text-3xl font-bold text-purple-500 mb-2" id="memberDays">0</div>
          <div class="text-gray-400 text-sm font-medium">会员天数</div>
        </div>
      </div>
    </div>

    <!-- 内容网格 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- 观看历史 -->
      <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-white flex items-center gap-3">
            <i class="fas fa-history text-orange-500"></i>
            观看历史
          </h2>
          <a href="#" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors">
            查看全部 <i class="fas fa-arrow-right ml-1"></i>
          </a>
        </div>

        <div id="watchHistory" class="space-y-4">
          <div class="text-center py-12 text-gray-500">
            <i class="fas fa-history text-6xl mb-4 opacity-50"></i>
            <p class="text-lg">暂无观看记录</p>
          </div>
        </div>
      </div>

      <!-- 收藏影片 -->
      <div class="bg-gray-800 rounded-2xl p-6 shadow-xl">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-white flex items-center gap-3">
            <i class="fas fa-heart text-red-500"></i>
            收藏影片
          </h2>
          <a href="#" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors">
            查看全部 <i class="fas fa-arrow-right ml-1"></i>
          </a>
        </div>

        <div id="favoriteMovies" class="space-y-4">
          <div class="text-center py-12 text-gray-500">
            <i class="fas fa-heart text-6xl mb-4 opacity-50"></i>
            <p class="text-lg">暂无收藏影片</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 用户中心页面专用JavaScript
  document.addEventListener('DOMContentLoaded', async function () {
    loadUserInfo();
    loadWatchHistory();
    await loadStatistics();
  });

  // 全局通知系统
  window.showNotification = function (message, type = 'info', duration = 3000) {
    const notification = document.createElement('div');
    const bgColor = {
      success: 'bg-green-500',
      error: 'bg-red-500',
      warning: 'bg-yellow-500',
      info: 'bg-blue-500'
    }[type] || 'bg-blue-500';

    notification.className = `fixed top-4 right-4 z-50 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
    notification.textContent = message;

    document.body.appendChild(notification);

    // Slide in
    setTimeout(() => {
      notification.classList.remove('translate-x-full');
    }, 100);

    // Slide out and remove
    setTimeout(() => {
      notification.classList.add('translate-x-full');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, duration);
  };

  async function loadUserInfo() {
    try {
      const token = localStorage.getItem('auth_token');
      if (!token) {
        window.location.href = '/';
        return;
      }

      const response = await fetch('/api/auth/me', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const data = await response.json();
        const user = data.user;

        // 更新用户信息显示
        const displayName = user.user_nick_name || user.user_name;
        document.getElementById('userDisplayNameLarge').textContent = displayName;
        document.getElementById('username').textContent = user.user_name;
        document.getElementById('email').textContent = user.user_email || '未设置';

        // 格式化注册时间
        const regDate = user.created_at ? new Date(user.created_at.$date.$numberLong) : new Date();
        document.getElementById('regDate').textContent = regDate.toLocaleDateString('zh-CN');

        // 更新头像
        const avatarUrl = user.user_portrait || '/static/images/default-avatar.svg';
        document.getElementById('userAvatarLarge').src = avatarUrl;
      } else {
        window.location.href = '/';
      }
    } catch (error) {
      console.error('加载用户信息失败:', error);
      window.location.href = '/';
    }
  }

  function loadWatchHistory() {
    // 从localStorage加载播放记录
    const history = JSON.parse(localStorage.getItem('video_play_history') || '[]');
    const historyContainer = document.getElementById('watchHistory');

    if (history.length === 0) {
      historyContainer.innerHTML = `
      <div class="text-center py-12 text-gray-500">
        <i class="fas fa-history text-6xl mb-4 opacity-50"></i>
        <p class="text-lg">暂无观看记录</p>
      </div>
    `;
      return;
    }

    const historyHTML = history.slice(0, 5).map(item => `
    <div class="flex items-center gap-4 p-4 bg-gray-700 rounded-xl hover:bg-gray-600 transition-colors duration-200">
      <img src="${item.poster || '/static/images/default-avatar.svg'}" alt="${item.name}" 
           class="w-16 h-12 rounded-lg object-cover bg-gray-600">
      <div class="flex-1">
        <div class="text-white font-medium mb-1">${item.name}</div>
        <div class="text-gray-400 text-sm">
          ${item.episode} - ${item.watchTime}
        </div>
      </div>
    </div>
  `).join('');

    historyContainer.innerHTML = historyHTML;
  }

  async function loadStatistics() {
    // 计算统计数据
    const history = JSON.parse(localStorage.getItem('video_play_history') || '[]');

    document.getElementById('totalWatched').textContent = history.length;

    // 简化的观看时长计算（假设每个视频平均30分钟）
    const totalMinutes = history.length * 30;
    const totalHours = Math.floor(totalMinutes / 60);
    document.getElementById('totalTime').textContent = totalHours + 'h';

    // 获取真实会员信息
    try {
      const token = localStorage.getItem('auth_token');
      const response = await fetch('/api/user/vip-info', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (response.ok) {
        const data = await response.json();

        // 更新积分
        document.getElementById('userPoints').textContent = data.user_points;

        // 更新会员状态
        if (data.is_vip && data.vip_end_date) {
          const endDate = new Date(data.vip_end_date);
          const now = new Date();
          const daysLeft = Math.ceil((endDate - now) / (1000 * 60 * 60 * 24));

          if (daysLeft > 0) {
            document.getElementById('memberDays').textContent = `${daysLeft}天`;
            // 更新会员等级显示
            const memberDaysElement = document.getElementById('memberDays');
            memberDaysElement.innerHTML = `${daysLeft}天<br><small class="text-gray-400">VIP${data.vip_level}</small>`;
          } else {
            document.getElementById('memberDays').textContent = '已过期';
          }
        } else {
          document.getElementById('memberDays').textContent = '非会员';
        }
      } else {
        // 如果获取失败，使用默认值
        document.getElementById('userPoints').textContent = '0';
        document.getElementById('memberDays').textContent = '非会员';
      }
    } catch (error) {
      console.error('获取会员信息失败:', error);
      document.getElementById('userPoints').textContent = '0';
      document.getElementById('memberDays').textContent = '非会员';
    }
  }

  function editProfile() {
    // 创建一个现代化的提示框
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
    <div class="bg-gray-800 rounded-2xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95">
      <div class="text-center">
        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-tools text-white text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">功能开发中</h3>
        <p class="text-gray-400 mb-6">编辑资料功能正在开发中，敬请期待！</p>
        <button onclick="this.closest('.fixed').remove()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
          我知道了
        </button>
      </div>
    </div>
  `;

    document.body.appendChild(modal);

    // 添加动画效果
    setTimeout(() => {
      modal.querySelector('div > div').classList.remove('scale-95');
      modal.querySelector('div > div').classList.add('scale-100');
    }, 10);
  }

  // 购买卡卷
  async function goToBuyCard() {
    try {
      // 获取购买卡卷链接
      const response = await fetch('/api/config/buy_card');
      const data = await response.json();

      // console.log(data);

      if (data.success && data.config_value) {
        // 在新窗口打开购买链接
        window.open(data.config_value, '_blank');
      } else {
        window.showNotification('购买链接暂未配置', 'warning');
      }
    } catch (error) {
      console.error('获取购买链接失败:', error);
      window.showNotification('获取购买链接失败', 'error');
    }
  }

  // 显示使用卡卷弹窗
  function showUseCardModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
    <div class="bg-gray-800 rounded-2xl p-8 max-w-md mx-4 transform transition-all duration-300 scale-95">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-credit-card text-white text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">使用卡卷</h3>
        <p class="text-gray-400">请输入您的卡卷代码</p>
        <p class="text-gray-400">注意：如果升级或者降级VIP，会重置会员时长。</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <input type="text" id="cardCode" placeholder="请输入10位卡卷代码" 
                 class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg text-gray placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                 maxlength="10">
        </div>
        
        <div class="flex gap-3">
          <button onclick="useCard()" 
                  class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
            确认使用
          </button>
          <button onclick="this.closest('.fixed').remove()" 
                  class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors duration-200">
            取消
          </button>
        </div>
      </div>
    </div>
  `;

    document.body.appendChild(modal);

    // 添加动画效果
    setTimeout(() => {
      modal.querySelector('div > div').classList.remove('scale-95');
      modal.querySelector('div > div').classList.add('scale-100');
    }, 10);

    // 自动聚焦到输入框
    setTimeout(() => {
      document.getElementById('cardCode').focus();
    }, 100);
  }

  // 使用卡卷
  async function useCard() {
    const cardCode = document.getElementById('cardCode').value.trim();

    if (!cardCode) {
      window.showNotification('请输入卡卷代码', 'warning');
      return;
    }

    if (cardCode.length !== 10) {
      window.showNotification('卡卷代码必须是10位', 'warning');
      return;
    }

    try {
      const token = localStorage.getItem('auth_token');
      console.log(token);
      const response = await fetch('/api/user/use-card', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ card_code: cardCode })
      });

      const result = await response.json();

      if (result.success) {
        window.showNotification(result.message, 'success');
        // 关闭弹窗
        document.querySelector('.fixed.inset-0').remove();
        // 重新加载会员信息
        setTimeout(async () => {
          await loadStatistics();
        }, 1000);
      } else {
        window.showNotification(result.message, 'error');
      }
    } catch (error) {
      console.error('使用卡卷失败:', error);
      window.showNotification('网络错误，请稍后重试', 'error');
    }
  }
</script>
{% endblock %}